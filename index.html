<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
<title>RSSã¾ã¨ã‚ã‚¹ãƒãƒ¼ãƒˆãƒªãƒ¼ãƒ€ãƒ¼</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Noto+Serif+JP:wght@400;700&family=Noto+Sans+JP:wght@300;400;500;700&display=swap" rel="stylesheet">
<style>
/* ================================================
   CSSå¤‰æ•° & ãƒªã‚»ãƒƒãƒˆ
   ================================================ */
:root {
  --bg:         #090909;
  --bg2:        #111113;
  --bg3:        #18181c;
  --bg4:        #1f1f24;
  --border:     #252528;
  --border2:    #2e2e34;
  --accent:     #e8a020;
  --accent2:    #f0c060;
  --text:       #e4e2dc;
  --text2:      #a8a6a0;
  --text3:      #606060;
  --blue:       #6aaae0;
  --red:        #e07060;
  --panel-w:    280px;
  --header-h:   52px;
  --font-serif: 'Noto Serif JP', 'Hiragino Mincho ProN', serif;
  --font-sans:  'Noto Sans JP', 'Hiragino Kaku Gothic ProN', sans-serif;
  --radius:     8px;
  --trans:      0.2s ease;
}

*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

html, body {
  height: 100%;
  background: var(--bg);
  color: var(--text);
  font-family: var(--font-sans);
  font-size: 14px;
  line-height: 1.6;
  overflow: hidden;
  -webkit-font-smoothing: antialiased;
}

button { font-family: var(--font-sans); cursor: pointer; border: none; outline: none; }
a { color: inherit; text-decoration: none; }
ul { list-style: none; }
input { font-family: var(--font-sans); }

/* ================================================
   ã‚¢ãƒ—ãƒªå…¨ä½“ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ
   ================================================ */
#app {
  display: flex;
  height: 100vh;
  overflow: hidden;
  position: relative;
}

/* ================================================
   å·¦ãƒ‘ãƒãƒ«ï¼šãƒ•ã‚£ãƒ¼ãƒ‰ãƒªã‚¹ãƒˆ
   ================================================ */
#feed-panel {
  width: var(--panel-w);
  flex-shrink: 0;
  background: var(--bg2);
  border-right: 1px solid var(--border);
  display: flex;
  flex-direction: column;
  height: 100vh;
  transition: transform var(--trans);
  z-index: 10;
}

.feed-panel-header {
  padding: 16px 16px 12px;
  border-bottom: 1px solid var(--border);
  flex-shrink: 0;
}

.app-title {
  font-family: var(--font-serif);
  font-size: 18px;
  font-weight: 700;
  color: var(--accent);
  letter-spacing: 0.05em;
  margin-bottom: 2px;
}

.app-subtitle {
  font-size: 10px;
  color: var(--text3);
  letter-spacing: 0.08em;
}

.feed-list {
  flex: 1;
  overflow-y: auto;
  min-height: 0;
  padding: 8px 0;
  scrollbar-width: thin;
  scrollbar-color: var(--border2) transparent;
  -webkit-overflow-scrolling: touch;
}

.feed-item {
  display: flex;
  align-items: center;
  gap: 10px;
  padding: 10px 16px;
  cursor: pointer;
  transition: background var(--trans);
  border-radius: 0;
  position: relative;
}

.feed-item:hover { background: var(--bg3); }
.feed-item.active { background: var(--bg4); }
.feed-item.active::before {
  content: '';
  position: absolute;
  left: 0; top: 0; bottom: 0;
  width: 3px;
  background: var(--accent);
  border-radius: 0 2px 2px 0;
}

.feed-icon {
  width: 28px; height: 28px;
  border-radius: 6px;
  background: var(--bg4);
  border: 1px solid var(--border2);
  display: flex; align-items: center; justify-content: center;
  font-size: 14px;
  flex-shrink: 0;
  overflow: hidden;
}

.feed-icon img {
  width: 100%; height: 100%;
  object-fit: cover;
  border-radius: 5px;
}

.feed-info { flex: 1; min-width: 0; }
.feed-name {
  font-size: 12px;
  font-weight: 500;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  color: var(--text);
}

.feed-meta {
  font-size: 10px;
  color: var(--text3);
  display: flex;
  gap: 6px;
  margin-top: 1px;
}

.feed-unread {
  min-width: 18px; height: 18px;
  background: var(--accent);
  color: #000;
  border-radius: 9px;
  font-size: 10px;
  font-weight: 700;
  display: flex; align-items: center; justify-content: center;
  padding: 0 5px;
  flex-shrink: 0;
}

.feed-remove {
  width: 20px; height: 20px;
  background: transparent;
  color: var(--text3);
  font-size: 14px;
  border-radius: 4px;
  display: flex; align-items: center; justify-content: center;
  opacity: 0;
  transition: opacity var(--trans), background var(--trans);
  flex-shrink: 0;
}

.feed-item:hover .feed-remove { opacity: 1; }
.feed-remove:hover { background: rgba(224,112,96,0.2); color: var(--red); }

/* ãƒ•ã‚£ãƒ¼ãƒ‰è¿½åŠ ã‚¨ãƒªã‚¢ */
.add-feed-area {
  padding: 12px;
  border-top: 1px solid var(--border);
  flex-shrink: 0;
  overflow: visible;
}

.add-feed-row {
  display: flex;
  gap: 6px;
}

.add-feed-input {
  flex: 1;
  padding: 8px 10px;
  background: var(--bg3);
  border: 1px solid var(--border2);
  border-radius: var(--radius);
  color: var(--text);
  font-size: 12px;
  transition: border-color var(--trans);
}

.add-feed-input:focus {
  outline: none;
  border-color: var(--accent);
}

.add-feed-input::placeholder { color: var(--text3); }

.add-feed-btn {
  padding: 8px 12px;
  background: var(--accent);
  color: #000;
  border-radius: var(--radius);
  font-size: 12px;
  font-weight: 700;
  transition: background var(--trans);
  white-space: nowrap;
}

.add-feed-btn:hover { background: var(--accent2); }
.add-feed-btn:disabled { background: var(--bg4); color: var(--text3); cursor: default; }

.add-feed-hint {
  font-size: 10px;
  color: var(--text3);
  margin-top: 6px;
  line-height: 1.5;
}

/* ================================================
   ä¸­å¤®ãƒ‘ãƒãƒ«ï¼šè¨˜äº‹ä¸€è¦§
   ================================================ */
#article-panel {
  flex: 1;
  display: flex;
  flex-direction: column;
  background: var(--bg);
  border-right: 1px solid var(--border);
  min-width: 0;
  max-width: 420px;
}

.article-panel-header {
  padding: 0 16px;
  height: var(--header-h);
  display: flex;
  align-items: center;
  justify-content: space-between;
  border-bottom: 1px solid var(--border);
  flex-shrink: 0;
  gap: 8px;
}

.panel-feed-title {
  font-family: var(--font-serif);
  font-size: 15px;
  font-weight: 700;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  color: var(--text);
}

.refresh-btn {
  padding: 5px 10px;
  background: var(--bg3);
  border: 1px solid var(--border2);
  border-radius: 6px;
  color: var(--text2);
  font-size: 11px;
  transition: background var(--trans), color var(--trans);
  flex-shrink: 0;
  display: flex; align-items: center; gap: 4px;
}

.refresh-btn:hover { background: var(--bg4); color: var(--text); }
.refresh-btn.loading .refresh-icon { animation: spin 1s linear infinite; }

@keyframes spin { to { transform: rotate(360deg); } }

.article-list {
  flex: 1;
  overflow-y: auto;
  scrollbar-width: thin;
  scrollbar-color: var(--border2) transparent;
}

.article-item {
  padding: 14px 16px;
  border-bottom: 1px solid var(--border);
  cursor: pointer;
  transition: background var(--trans);
  position: relative;
}

.article-item:hover { background: var(--bg2); }
.article-item.active { background: var(--bg3); }
.article-item.unread::after {
  content: '';
  position: absolute;
  right: 14px; top: 50%;
  transform: translateY(-50%);
  width: 6px; height: 6px;
  border-radius: 50%;
  background: var(--accent);
}

.article-thumb {
  width: 100%;
  height: 120px;
  object-fit: cover;
  border-radius: 6px;
  margin-bottom: 10px;
  display: block;
}

.article-title {
  font-family: var(--font-serif);
  font-size: 13px;
  font-weight: 700;
  line-height: 1.55;
  color: var(--text);
  margin-bottom: 6px;
  display: -webkit-box;
  -webkit-line-clamp: 3;
  -webkit-box-orient: vertical;
  overflow: hidden;
}

.article-item.read .article-title { color: var(--text3); }

.article-meta {
  display: flex;
  gap: 8px;
  font-size: 10px;
  color: var(--text3);
  align-items: center;
}

.article-feed-badge {
  background: var(--bg3);
  border: 1px solid var(--border2);
  border-radius: 4px;
  padding: 1px 6px;
  font-size: 9px;
  color: var(--text3);
  max-width: 100px;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

/* ç©ºã®çŠ¶æ…‹ */
.empty-state {
  flex: 1;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  gap: 12px;
  color: var(--text3);
  padding: 40px 20px;
  text-align: center;
}

.empty-state .icon { font-size: 40px; opacity: 0.4; }
.empty-state .msg { font-size: 13px; line-height: 1.7; }

/* ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚° */
.loading-state {
  display: flex;
  flex-direction: column;
  gap: 1px;
}

.skeleton {
  padding: 14px 16px;
  border-bottom: 1px solid var(--border);
}

.skeleton-bar {
  background: var(--bg3);
  border-radius: 4px;
  animation: pulse 1.5s ease-in-out infinite;
}

@keyframes pulse {
  0%, 100% { opacity: 0.4; }
  50% { opacity: 0.8; }
}

/* ================================================
   å³ãƒ‘ãƒãƒ«ï¼šãƒªãƒ¼ãƒ€ãƒ¼ãƒ¢ãƒ¼ãƒ‰
   ================================================ */
#reader-panel {
  flex: 1;
  display: flex;
  flex-direction: column;
  background: var(--bg);
  min-width: 0;
  position: relative;
}

.reader-empty {
  flex: 1;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  color: var(--text3);
  gap: 16px;
  padding: 40px;
  text-align: center;
}

.reader-empty .big-icon {
  font-size: 56px;
  opacity: 0.2;
}

.reader-empty .hint {
  font-size: 13px;
  line-height: 1.8;
  max-width: 300px;
}

.reader-header {
  height: var(--header-h);
  display: flex;
  align-items: center;
  padding: 0 20px;
  border-bottom: 1px solid var(--border);
  gap: 8px;
  flex-shrink: 0;
}

.reader-controls {
  display: flex;
  align-items: center;
  gap: 6px;
  margin-left: auto;
}

.ctrl-btn {
  padding: 5px 10px;
  background: var(--bg3);
  border: 1px solid var(--border2);
  border-radius: 6px;
  color: var(--text2);
  font-size: 11px;
  transition: background var(--trans), color var(--trans);
}

.ctrl-btn:hover { background: var(--bg4); color: var(--text); }

.ctrl-btn.active {
  background: rgba(106,170,224,0.15);
  border-color: rgba(106,170,224,0.4);
  color: var(--blue);
}

.reader-url {
  font-size: 11px;
  color: var(--text3);
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  max-width: 260px;
}

.reader-body {
  flex: 1;
  overflow-y: auto;
  padding: 40px 60px 80px;
  scrollbar-width: thin;
  scrollbar-color: var(--border2) transparent;
}

.reader-body::-webkit-scrollbar { width: 5px; }
.reader-body::-webkit-scrollbar-track { background: transparent; }
.reader-body::-webkit-scrollbar-thumb { background: var(--border2); border-radius: 3px; }

.reader-article-title {
  font-family: var(--font-serif);
  font-size: 22px;
  font-weight: 700;
  line-height: 1.55;
  color: var(--text);
  margin-bottom: 8px;
  max-width: 680px;
}

.reader-article-meta {
  display: flex;
  gap: 12px;
  font-size: 11px;
  color: var(--text3);
  margin-bottom: 28px;
  align-items: center;
  flex-wrap: wrap;
}

.reader-article-meta a {
  color: var(--blue);
  border-bottom: 1px solid rgba(106,170,224,0.3);
}

.reader-hero {
  max-width: 680px;
  margin-bottom: 28px;
  border-radius: 8px;
  overflow: hidden;
}

.reader-hero img {
  width: 100%;
  display: block;
  max-height: 400px;
  object-fit: cover;
}

/* è¨˜äº‹ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã®ã‚¹ã‚¿ã‚¤ãƒ« */
.reader-content {
  max-width: 680px;
  font-size: 15px;
  line-height: 1.9;
  color: var(--text);
  font-feature-settings: "palt";
  word-break: break-word;
}

/* ã‚µã‚¤ãƒˆã®è‰²ä»˜ãæ–‡å­—ã‚’å¼·åˆ¶ä¸Šæ›¸ã */
.reader-content * {
  color: var(--text) !important;
  background-color: transparent !important;
}
.reader-content a,
.reader-content a * { color: var(--blue) !important; }
.reader-content h1, .reader-content h1 *,
.reader-content h2, .reader-content h2 *,
.reader-content h3, .reader-content h3 *,
.reader-content h4, .reader-content h4 * { color: var(--accent) !important; }

/* ã‚³ãƒ¡ãƒ³ãƒˆæ¬„ã®è‰²ã‚‚çµ±ä¸€ */
.comments-inner * {
  color: var(--text2) !important;
  background-color: transparent !important;
}
.comments-inner a, .comments-inner a * { color: var(--blue) !important; }

.reader-content h1,
.reader-content h2,
.reader-content h3,
.reader-content h4 {
  font-family: var(--font-serif);
  color: var(--accent);
  margin: 32px 0 14px;
  line-height: 1.4;
}

.reader-content h2 {
  font-size: 17px;
  border-left: 3px solid var(--accent);
  padding-left: 12px;
}

.reader-content h3 { font-size: 15px; }

.reader-content p { margin: 0 0 18px; }

.reader-content a {
  color: var(--blue);
  border-bottom: 1px solid rgba(106,170,224,0.3);
}

.reader-content img {
  max-width: 100%;
  height: auto;
  border-radius: 6px;
  margin: 12px 0;
  display: block;
}

.reader-content blockquote {
  border-left: 3px solid var(--border2);
  margin: 20px 0;
  padding: 12px 20px;
  background: var(--bg2);
  border-radius: 0 6px 6px 0;
  color: var(--text2);
}

.reader-content ul,
.reader-content ol {
  padding-left: 22px;
  margin: 0 0 18px;
}

.reader-content li { margin-bottom: 8px; }

.reader-content table {
  width: 100%;
  border-collapse: collapse;
  margin: 20px 0;
  font-size: 13px;
}

.reader-content th,
.reader-content td {
  padding: 10px 14px;
  border: 1px solid var(--border2);
  text-align: left;
}

.reader-content th {
  background: var(--bg3);
  color: var(--accent);
}

/* ãƒªãƒ¼ãƒ€ãƒ¼ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚° */
.reader-loading {
  padding: 40px 60px;
  display: flex;
  flex-direction: column;
  gap: 16px;
  max-width: 740px;
}

/* ã‚³ãƒ¡ãƒ³ãƒˆã‚»ã‚¯ã‚·ãƒ§ãƒ³ */
.comments-section {
  max-width: 680px;
  margin-top: 40px;
  padding-top: 24px;
  border-top: 1px solid var(--border2);
}

.comments-section.hidden { display: none; }

.comments-title {
  font-family: var(--font-serif);
  font-size: 15px;
  color: var(--blue);
  margin-bottom: 16px;
  display: flex;
  align-items: center;
  justify-content: space-between;
}

.comments-hide-btn {
  font-size: 11px;
  padding: 3px 8px;
  background: var(--bg3);
  border: 1px solid var(--border2);
  border-radius: 5px;
  color: var(--text3);
}

.comments-inner {
  color: var(--text2);
  font-size: 13px;
  line-height: 1.8;
}

.comments-inner li {
  padding: 10px 0;
  border-bottom: 1px solid var(--border);
  list-style: none;
}

.comments-inner a { color: #5a8cbf; }

.comments-inner blockquote,
.comments-inner [class*='quote'] {
  border-left: 2px solid var(--border2);
  padding: 6px 12px;
  margin: 6px 0;
  background: var(--bg2);
  color: var(--text3);
  font-size: 12px;
  border-radius: 0 4px 4px 0;
}

/* ================================================
   ãƒˆãƒ¼ã‚¹ãƒˆé€šçŸ¥
   ================================================ */
#toast {
  position: fixed;
  bottom: 24px;
  left: 50%;
  transform: translateX(-50%) translateY(20px);
  background: var(--bg4);
  border: 1px solid var(--border2);
  border-radius: 20px;
  padding: 8px 20px;
  font-size: 12px;
  color: var(--text);
  opacity: 0;
  transition: opacity 0.2s, transform 0.2s;
  pointer-events: none;
  z-index: 9999;
  white-space: nowrap;
  box-shadow: 0 4px 24px rgba(0,0,0,0.4);
}

#toast.show {
  opacity: 1;
  transform: translateX(-50%) translateY(0);
}

/* ================================================
   ãƒ¢ãƒã‚¤ãƒ«å¯¾å¿œ
   ================================================ */
@media (max-width: 900px) {
  #article-panel { max-width: none; }
  #reader-panel { display: none; }
}

@media (max-width: 640px) {
  #feed-panel {
    position: fixed;
    top: 0; left: 0; bottom: 0;
    transform: translateX(-100%);
    z-index: 100;
    box-shadow: 4px 0 24px rgba(0,0,0,0.5);
  }

  #feed-panel.open { transform: translateX(0); }

  #article-panel {
    width: 100vw;
    max-width: none;
    border-right: none;
  }

  #article-panel.hidden { display: none; }

  .mobile-reader-overlay {
    position: fixed !important;
    inset: 0 !important;
    z-index: 200 !important;
    background: var(--bg) !important;
    display: flex !important;
    flex-direction: column !important;
  }

  .reader-body {
    padding: 24px 20px 60px;
  }

  .reader-article-title { font-size: 18px; }
  .reader-content { font-size: 14px; }
}

/* ãƒ¢ãƒã‚¤ãƒ«ãƒ˜ãƒƒãƒ€ãƒ¼ */
.mobile-top-bar {
  display: none;
  height: var(--header-h);
  background: var(--bg2);
  border-bottom: 1px solid var(--border);
  align-items: center;
  padding: 0 14px;
  gap: 10px;
  flex-shrink: 0;
}

@media (max-width: 640px) {
  .mobile-top-bar { display: flex; }
}

.mobile-menu-btn {
  width: 34px; height: 34px;
  background: var(--bg3);
  border: 1px solid var(--border2);
  border-radius: 8px;
  color: var(--text2);
  font-size: 16px;
  display: flex; align-items: center; justify-content: center;
}

.mobile-panel-title {
  font-family: var(--font-serif);
  font-size: 15px;
  font-weight: 700;
  color: var(--accent);
  flex: 1;
}

/* ãƒ•ã‚£ãƒ¼ãƒ‰ãƒ‰ãƒ­ãƒ¯ãƒ¼ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ */
.drawer-overlay {
  display: none;
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.6);
  z-index: 99;
}

.drawer-overlay.show { display: block; }

/* ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãƒãƒ¼å…¨ä½“ */
::-webkit-scrollbar { width: 5px; }
::-webkit-scrollbar-track { background: transparent; }
::-webkit-scrollbar-thumb { background: var(--border2); border-radius: 3px; }

/* ================================================
   ã‚µã‚¤ãƒˆé‹å–¶è€…åºƒå‘Šã‚¨ãƒªã‚¢
   ================================================ */
.reader-sponsor-ad {
  max-width: 680px;
  margin: 28px 0 8px;
  padding: 14px 16px 10px;
  border: 1px solid var(--border2);
  border-radius: 8px;
  background: var(--bg2);
  position: relative;
}

.reader-sponsor-ad::before {
  content: 'ã‚µã‚¤ãƒˆé‹å–¶è€…ã®åºƒå‘Š';
  position: absolute;
  top: -9px;
  left: 14px;
  background: var(--bg2);
  padding: 0 8px;
  font-size: 10px;
  color: var(--text3);
  letter-spacing: 0.06em;
  border: 1px solid var(--border2);
  border-radius: 4px;
}

.reader-sponsor-ad ins,
.reader-sponsor-ad iframe,
.reader-sponsor-ad img {
  max-width: 100% !important;
  height: auto !important;
  display: block !important;
  margin: 0 auto !important;
}


/* ================================================
   Twitterã‚«ãƒ¼ãƒ‰
   ================================================ */
.tweet-card {
  border: 1px solid var(--border2);
  border-radius: 12px;
  padding: 14px 16px;
  margin: 16px 0;
  background: var(--bg2);
  max-width: 520px;
}

.tweet-card-header {
  display: flex;
  align-items: center;
  gap: 6px;
  margin-bottom: 10px;
}

.tweet-card-icon {
  font-size: 16px;
  font-weight: 900;
  color: var(--text2);
}

.tweet-card-label {
  font-size: 11px;
  color: var(--text3);
  letter-spacing: 0.05em;
}

.tweet-card-text {
  font-size: 14px;
  line-height: 1.7;
  color: var(--text);
  margin-bottom: 10px;
  white-space: pre-wrap;
  word-break: break-word;
}

.tweet-card-link {
  font-size: 12px;
  color: var(--blue) !important;
  border-bottom: 1px solid rgba(106,170,224,0.3) !important;
  display: inline-block;
}

.tweet-card-link:hover {
  color: #8dcaff !important;
}


/* ãƒ©ã‚¤ãƒˆãƒ†ãƒ¼ãƒ */
body.light {
  --bg:#f5f3ee;--bg2:#eceae4;--bg3:#e2e0d8;--bg4:#d8d6cc;
  --border:#d0cec4;--border2:#c4c2b8;
  --accent:#c07800;--accent2:#e09000;
  --text:#1a1a1a;--text2:#555550;--text3:#999990;
  --blue:#1a60b0;--red:#c04030;
}
.feed-panel-header-row{display:flex;align-items:center;justify-content:space-between;gap:8px}
.theme-toggle-btn{width:32px;height:32px;background:var(--bg3);border:1px solid var(--border2);border-radius:8px;color:var(--text2);font-size:14px;display:flex;align-items:center;justify-content:center;flex-shrink:0;transition:background var(--trans),color var(--trans)}
.theme-toggle-btn:hover{background:var(--bg4);color:var(--accent)}
.panel-toggle-btn{width:22px;height:44px;background:var(--bg3);border:1px solid var(--border2);border-radius:0 6px 6px 0;color:var(--text3);font-size:10px;cursor:pointer;display:flex;align-items:center;justify-content:center;flex-shrink:0;transition:background var(--trans),color var(--trans);align-self:center;position:relative;z-index:5}
.panel-toggle-btn:hover{background:var(--bg4);color:var(--accent)}
#feed-panel.collapsed{width:0!important;min-width:0!important;overflow:hidden!important;border-right:none!important}
#article-panel.collapsed{width:0!important;min-width:0!important;max-width:0!important;overflow:hidden!important;border-right:none!important}
.recommended-btn{width:100%;padding:16px 12px;background:var(--bg3);border:1px solid var(--border2);border-radius:var(--radius);color:var(--text2);font-size:13px;text-align:left;display:flex;align-items:center;gap:6px;margin-top:6px;transition:background var(--trans),color var(--trans);min-height:52px}
.recommended-btn:hover{background:var(--bg4);color:var(--text)}
#recommendedPanel{display:none;position:fixed;top:0;left:0;bottom:0;width:320px;background:var(--bg2);border-right:1px solid var(--border);z-index:200;flex-direction:column;box-shadow:4px 0 24px rgba(0,0,0,0.5)}
#recommendedPanel.open{display:flex}
.rec-panel-header{padding:16px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;flex-shrink:0}
.rec-panel-title{font-family:var(--font-serif);font-size:15px;font-weight:700;color:var(--accent)}
.rec-panel-close{width:28px;height:28px;background:var(--bg3);border:1px solid var(--border2);border-radius:6px;color:var(--text2);font-size:14px;display:flex;align-items:center;justify-content:center}
.rec-panel-close:hover{color:var(--red);background:var(--bg4)}
.rec-list{flex:1;overflow-y:auto;padding:8px 0;scrollbar-width:thin;scrollbar-color:var(--border2) transparent}
.rec-category{padding:10px 16px 4px;font-size:10px;color:var(--text3);letter-spacing:.1em;font-weight:700;border-top:1px solid var(--border);margin-top:4px}
.rec-category:first-child{border-top:none;margin-top:0}
.rec-item{display:flex;align-items:center;padding:9px 16px;gap:10px}
.rec-item-name{flex:1;font-size:12px;color:var(--text);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.rec-add-btn{padding:4px 10px;background:var(--accent);color:#000;border-radius:5px;font-size:11px;font-weight:700;flex-shrink:0;transition:background var(--trans),opacity var(--trans);cursor:pointer;border:none}
.rec-add-btn:hover{background:var(--accent2)}
.rec-add-btn:disabled,.rec-add-btn.added{background:var(--bg4);color:var(--text3);cursor:default;opacity:.6}
</style>
</head>
<body>

<!-- ãƒ¢ãƒã‚¤ãƒ«ãƒ‰ãƒ­ãƒ¯ãƒ¼ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ -->
<div class="drawer-overlay" id="drawerOverlay"></div>

<div id="app">
  <!-- å·¦ãƒ‘ãƒãƒ«ï¼šãƒ•ã‚£ãƒ¼ãƒ‰ãƒªã‚¹ãƒˆ -->
  <div id="feed-panel">
    <div class="feed-panel-header">
      <div class="feed-panel-header-row">
        <div>
          <div class="app-title">RSSã¾ã¨ã‚ã‚¹ãƒãƒ¼ãƒˆãƒªãƒ¼ãƒ€ãƒ¼</div>
          <div class="app-subtitle">RSS MATOME SMART READER</div>
        </div>
        <button class="theme-toggle-btn" id="themeToggleBtn" title="ãƒ†ãƒ¼ãƒåˆ‡æ›¿">â˜¾</button>
      </div>
    </div>

    <ul class="feed-list" id="feedList"></ul>

    <div class="add-feed-area">
      <div class="add-feed-row">
        <input type="url" class="add-feed-input" id="feedUrlInput"
               placeholder="RSSãƒ•ã‚£ãƒ¼ãƒ‰ã®URLã‚’å…¥åŠ›">
        <button class="add-feed-btn" id="addFeedBtn">è¿½åŠ </button>
      </div>
      <p class="add-feed-hint">ä¾‹ï¼šRSSã®URLã§ã‚‚ã‚µã‚¤ãƒˆã®URLã§ã‚‚OK</p>
      <button class="recommended-btn" id="openRecommendedBtn">ğŸ“‹ ãŠã™ã™ã‚ãƒ•ã‚£ãƒ¼ãƒ‰ã‚’è¿½åŠ </button>
    </div>
  </div>

  <!-- ãŠã™ã™ã‚ãƒ•ã‚£ãƒ¼ãƒ‰ãƒ‘ãƒãƒ« -->
  <div id="recommendedPanel">
    <div class="rec-panel-header">
      <span class="rec-panel-title">ãŠã™ã™ã‚ãƒ•ã‚£ãƒ¼ãƒ‰</span>
      <button class="rec-panel-close" id="closeRecommendedBtn">âœ•</button>
    </div>
    <div class="rec-list" id="recList"></div>
  </div>

  <!-- å·¦ãƒ‘ãƒãƒ«ãƒˆã‚°ãƒ« -->
  <button class="panel-toggle-btn" id="feedToggleBtn" title="ãƒ•ã‚£ãƒ¼ãƒ‰æŠ˜ã‚ŠãŸãŸã¿">â—€</button>

  <!-- ä¸­å¤®ãƒ‘ãƒãƒ«ï¼šè¨˜äº‹ä¸€è¦§ -->
  <div id="article-panel">
    <!-- ãƒ¢ãƒã‚¤ãƒ«ç”¨ãƒˆãƒƒãƒ—ãƒãƒ¼ -->
    <div class="mobile-top-bar">
      <button class="mobile-menu-btn" id="mobileMenuBtn">â˜°</button>
      <div class="mobile-panel-title" id="mobilePanelTitle">RSSã¾ã¨ã‚ã‚¹ãƒãƒ¼ãƒˆãƒªãƒ¼ãƒ€ãƒ¼</div>
    </div>

    <div class="article-panel-header" id="articlePanelHeader" style="display:none">
      <span class="panel-feed-title" id="panelFeedTitle">è¨˜äº‹ä¸€è¦§</span>
      <button class="refresh-btn" id="refreshBtn">
        <span class="refresh-icon">â†»</span> æ›´æ–°
      </button>
    </div>

    <div id="articleListContainer" style="flex:1;display:flex;flex-direction:column;overflow:hidden">
      <div class="empty-state" id="emptyFeedState">
        <div class="icon">ğŸ“¡</div>
        <div class="msg">å·¦ã®ãƒ‘ãƒãƒ«ã‹ã‚‰RSSãƒ•ã‚£ãƒ¼ãƒ‰ã‚’<br>è¿½åŠ ã—ã¦ãã ã•ã„</div>
      </div>
    </div>
  </div>

  <!-- ä¸­å¤®ãƒ‘ãƒãƒ«ãƒˆã‚°ãƒ« -->
  <button class="panel-toggle-btn" id="articleToggleBtn" title="è¨˜äº‹ä¸€è¦§æŠ˜ã‚ŠãŸãŸã¿">â—€</button>

  <!-- å³ãƒ‘ãƒãƒ«ï¼šãƒªãƒ¼ãƒ€ãƒ¼ -->
  <div id="reader-panel">
    <div class="reader-empty" id="readerEmpty">
      <div class="big-icon">ğŸ“–</div>
      <div class="hint">è¨˜äº‹ã‚’é¸ã¶ã¨<br>ã“ã“ã§ãƒªãƒ¼ãƒ€ãƒ¼ãƒ¢ãƒ¼ãƒ‰ã§è¡¨ç¤ºã•ã‚Œã¾ã™</div>
    </div>

    <div id="readerContent" style="display:none;flex:1;flex-direction:column;overflow:hidden">
      <div class="reader-header" id="readerHeader">
        <span class="reader-url" id="readerUrl"></span>
        <div class="reader-controls">
          <button class="ctrl-btn" id="fontSmallBtn">Aâˆ’</button>
          <button class="ctrl-btn" id="fontLargeBtn">Aï¼‹</button>
          <button class="ctrl-btn" id="commentToggleBtn" style="display:none">ğŸ’¬</button>
          <a class="ctrl-btn" id="openOriginalBtn" target="_blank" rel="noopener">å…ƒè¨˜äº‹ â†’</a>
        </div>
      </div>
      <div class="reader-body" id="readerBody"></div>
    </div>
  </div>
</div>

<div id="toast"></div>

<script>
// ================================================
// ã‚¢ãƒ—ãƒªçŠ¶æ…‹
// ================================================
const state = {
  feeds: [],          // { id, title, url, favicon, lastFetch, errorCount }
  articles: [],       // { id, feedId, feedTitle, title, url, date, thumb, read }
  selectedFeedId: null,
  selectedArticleId: null,
  readerFontSize: 15,
  commentsVisible: false,
};

// ================================================
// ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸
// ================================================
const Storage = {
  save() {
    localStorage.setItem('yomimono_feeds', JSON.stringify(state.feeds));
    localStorage.setItem('yomimono_read', JSON.stringify(
      state.articles.filter(a => a.read).map(a => a.url)
    ));
  },
  load() {
    try {
      const feeds = localStorage.getItem('yomimono_feeds');
      if (feeds) state.feeds = JSON.parse(feeds);
      const read = localStorage.getItem('yomimono_read');
      if (read) {
        const readUrls = new Set(JSON.parse(read));
        state.articles.forEach(a => { if (readUrls.has(a.url)) a.read = true; });
      }
    } catch(e) {}
  },
  saveRead() {
    localStorage.setItem('yomimono_read', JSON.stringify(
      state.articles.filter(a => a.read).map(a => a.url)
    ));
  }
};

// ================================================
// CORS ãƒ—ãƒ­ã‚­ã‚·çµŒç”±ã§ãƒ•ã‚§ãƒƒãƒ
// ================================================
const PROXIES = [
  'https://corsproxy.io/?',
  'https://api.allorigins.win/raw?url=',
  'https://api.codetabs.com/v1/proxy?quest=',
];

async function fetchWithTimeout(url, ms = 8000) {
  const ctrl = new AbortController();
  const timer = setTimeout(() => ctrl.abort(), ms);
  try {
    const res = await fetch(url, { signal: ctrl.signal });
    clearTimeout(timer);
    return res;
  } catch(e) { clearTimeout(timer); throw e; }
}

async function proxyFetchRaw(url) {
  let lastErr;
  for (const proxy of PROXIES) {
    try {
      const res = await fetchWithTimeout(proxy + encodeURIComponent(url), 8000);
      if (res.ok) return res;
      lastErr = new Error(`HTTP ${res.status}`);
    } catch(e) { lastErr = e; }
  }
  throw lastErr || new Error('å…¨ãƒ—ãƒ­ã‚­ã‚·ã§å–å¾—å¤±æ•—');
}

// RSS/XMLç”¨
async function proxyFetch(url) {
  const res = await proxyFetchRaw(url);
  return res.text();
}

// è¨˜äº‹HTMLç”¨ï¼šã‚¨ãƒ³ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è‡ªå‹•æ¤œå‡º
async function fetchArticleHTML(url) {
  const res = await proxyFetchRaw(url);

  const buf = await res.arrayBuffer();
  const bytes = new Uint8Array(buf);

  // å…ˆé ­4KBã‹ã‚‰charsetå®£è¨€ã‚’æ¢ã™
  const headBytes = bytes.slice(0, 4096);
  const headAscii = new TextDecoder('ascii', { fatal: false }).decode(headBytes);

  let encoding = 'UTF-8';
  // meta charset ã¾ãŸã¯ XMLå®£è¨€ã‚’æ¢ã™
  const charsetMatch = headAscii.match(/charset=["']?\s*([\w-]+)/i);
  if (charsetMatch) {
    const cs = charsetMatch[1].toLowerCase().replace(/[-_\s]/g, '');
    if (cs === 'shiftjis' || cs === 'sjis' || cs === 'xsjis') encoding = 'Shift_JIS';
    else if (cs === 'eucjp' || cs === 'eucjpms') encoding = 'EUC-JP';
    // utf8/utf-8ã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®ã¾ã¾ã§OK
  } else {
    // charsetå®£è¨€ãªã— â†’ ãƒã‚¤ãƒˆãƒ‘ã‚¿ãƒ¼ãƒ³ã§åˆ¤å®š
    let sjisHits = 0;
    const limit = Math.min(bytes.length - 1, 8192);
    for (let i = 0; i < limit; i++) {
      const b = bytes[i];
      if ((b >= 0x81 && b <= 0x9F) || (b >= 0xE0 && b <= 0xEF)) {
        const b2 = bytes[i + 1];
        if (b2 >= 0x40 && b2 <= 0xFC && b2 !== 0x7F) {
          sjisHits++;
          i++;
        }
      }
    }
    if (sjisHits > 20) encoding = 'Shift_JIS';
  }

  try {
    return new TextDecoder(encoding).decode(bytes);
  } catch(e) {
    return new TextDecoder('UTF-8', { fatal: false }).decode(bytes);
  }
}

// ================================================
// RSS ãƒ‘ãƒ¼ã‚µãƒ¼
// ================================================
function parseRSS(xml, feedUrl) {
  const parser = new DOMParser();
  const doc = parser.parseFromString(xml, 'application/xml');

  // ã‚¨ãƒ©ãƒ¼ãƒã‚§ãƒƒã‚¯
  if (doc.querySelector('parsererror')) {
    throw new Error('RSS/XMLã®ãƒ‘ãƒ¼ã‚¹ã«å¤±æ•—ã—ã¾ã—ãŸ');
  }

  const isAtom = !!doc.querySelector('feed');
  const items = [];

  if (isAtom) {
    // Atom
    doc.querySelectorAll('entry').forEach(entry => {
      const title = entry.querySelector('title')?.textContent?.trim() || '(ç„¡é¡Œ)';
      const link = entry.querySelector('link[rel="alternate"]')?.getAttribute('href')
                || entry.querySelector('link')?.getAttribute('href')
                || '';
      const date = entry.querySelector('published, updated')?.textContent || '';
      const thumb = extractThumbFromEntry(entry);
      if (link) items.push({ title, url: link, date: parseDate(date), thumb });
    });
  } else {
    // RSS 2.0
    doc.querySelectorAll('item').forEach(item => {
      const title = item.querySelector('title')?.textContent?.trim() || '(ç„¡é¡Œ)';
      const link = item.querySelector('link')?.textContent?.trim()
                || item.querySelector('guid')?.textContent?.trim()
                || '';
      const date = item.querySelector('pubDate, dc\\:date')?.textContent || '';
      const thumb = extractThumbFromItem(item);
      if (link) items.push({ title, url: link, date: parseDate(date), thumb });
    });
  }

  // ãƒ•ã‚£ãƒ¼ãƒ‰ã‚¿ã‚¤ãƒˆãƒ«
  const feedTitle = doc.querySelector('channel > title, feed > title')?.textContent?.trim()
    || new URL(feedUrl).hostname;

  // ãƒ•ã‚¡ãƒ“ã‚³ãƒ³
  const favicon = `https://www.google.com/s2/favicons?domain=${new URL(feedUrl).hostname}&sz=32`;

  return { feedTitle, favicon, items };
}

function extractThumbFromItem(item) {
  // media:thumbnail or media:content
  const media = item.querySelector('thumbnail, content');
  if (media) return media.getAttribute('url') || null;
  // enclosure
  const enc = item.querySelector('enclosure');
  if (enc && enc.getAttribute('type')?.startsWith('image')) return enc.getAttribute('url');
  // descriptionå†…ã®æœ€åˆã®img
  const desc = item.querySelector('description, encoded')?.textContent || '';
  const match = desc.match(/<img[^>]+src=["']([^"']+)["']/i);
  return match ? match[1] : null;
}

function extractThumbFromEntry(entry) {
  const media = entry.querySelector('thumbnail, content');
  if (media) return media.getAttribute('url') || null;
  const summary = entry.querySelector('summary, content')?.textContent || '';
  const match = summary.match(/<img[^>]+src=["']([^"']+)["']/i);
  return match ? match[1] : null;
}

function parseDate(str) {
  if (!str) return null;
  try { return new Date(str.trim()).toISOString(); } catch(e) { return null; }
}

function formatDate(iso) {
  if (!iso) return '';
  try {
    const d = new Date(iso);
    const now = new Date();
    const diff = now - d;
    if (diff < 3600000) return `${Math.floor(diff/60000)}åˆ†å‰`;
    if (diff < 86400000) return `${Math.floor(diff/3600000)}æ™‚é–“å‰`;
    if (diff < 604800000) return `${Math.floor(diff/86400000)}æ—¥å‰`;
    return d.toLocaleDateString('ja-JP');
  } catch(e) { return ''; }
}

// ================================================
// ãƒ•ã‚£ãƒ¼ãƒ‰ç®¡ç†
// ================================================
function genId() { return Math.random().toString(36).slice(2); }

// ã‚µã‚¤ãƒˆHTMLã‹ã‚‰RSSãƒ•ã‚£ãƒ¼ãƒ‰URLã‚’è‡ªå‹•æ¤œå‡º
async function detectRssFeedUrl(siteUrl) {
  const html = await proxyFetch(siteUrl);
  const parser = new DOMParser();
  const doc = parser.parseFromString(html, 'text/html');

  // <link rel="alternate" type="application/rss+xml"> or atom
  const selectors = [
    'link[type="application/rss+xml"]',
    'link[type="application/atom+xml"]',
    'link[type="application/rss"]',
    'link[rel="alternate"][href*="rss"]',
    'link[rel="alternate"][href*="feed"]',
    'link[rel="alternate"][href*="atom"]',
  ];

  for (const sel of selectors) {
    const el = doc.querySelector(sel);
    if (el) {
      const href = el.getAttribute('href');
      if (!href) continue;
      try {
        return new URL(href, siteUrl).href;
      } catch(e) {}
    }
  }

  // ã‚ˆãã‚ã‚‹ãƒ‘ã‚¹ã‚’è©¦ã™
  const commonPaths = ['/feed', '/rss', '/feed.xml', '/rss.xml', '/atom.xml', '/index.rss', '/feeds/posts/default'];
  const base = new URL(siteUrl).origin;
  for (const path of commonPaths) {
    try {
      const testUrl = base + path;
      const res = await fetch(PROXY + encodeURIComponent(testUrl));
      if (res.ok) {
        const text = await res.text();
        if (text.includes('<rss') || text.includes('<feed') || text.includes('<channel')) {
          return testUrl;
        }
      }
    } catch(e) {}
  }

  return null;
}

async function addFeed(url) {
  url = url.trim();
  if (!url) return;
  if (!url.startsWith('http')) url = 'https://' + url;

  if (state.feeds.some(f => f.url === url)) {
    showToast('ã™ã§ã«ç™»éŒ²ã•ã‚Œã¦ã„ã¾ã™');
    return;
  }

  showToast('ãƒ•ã‚£ãƒ¼ãƒ‰ã‚’ç¢ºèªã—ã¦ã„ã¾ã™...');

  try {
    let feedUrl = url;
    let xml;

    // ã¾ãšãã®ã¾ã¾RSSã¨ã—ã¦è©¦ã™
    try {
      xml = await proxyFetch(url);
      parseRSS(xml, url); // ãƒ‘ãƒ¼ã‚¹ã§ãã‚‹ã‹ç¢ºèªï¼ˆå¤±æ•—ã—ãŸã‚‰ä¾‹å¤–ï¼‰
    } catch(e) {
      // RSSç›´æ¥èª­ã¿è¾¼ã¿å¤±æ•— â†’ ã‚µã‚¤ãƒˆURLã¨ã—ã¦RSSã‚’è‡ªå‹•æ¤œå‡º
      showToast('RSSã‚’è‡ªå‹•æ¤œå‡ºä¸­...');
      const detected = await detectRssFeedUrl(url);
      if (!detected) throw new Error('RSSãƒ•ã‚£ãƒ¼ãƒ‰ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ');
      feedUrl = detected;
      xml = await proxyFetch(feedUrl);
    }

    const { feedTitle, favicon, items } = parseRSS(xml, feedUrl);

    const feed = { id: genId(), title: feedTitle, url: feedUrl, favicon, lastFetch: new Date().toISOString() };
    state.feeds.push(feed);

    const newArticles = items.slice(0, 30).map(item => ({
      id: genId(),
      feedId: feed.id,
      feedTitle: feed.title,
      title: item.title,
      url: item.url,
      date: item.date,
      thumb: item.thumb,
      read: false,
    }));
    state.articles.unshift(...newArticles);

    Storage.save();
    renderFeedList();
    if (!state.selectedFeedId) selectFeed(feed.id);
    else renderArticleList();

    showToast(`ã€Œ${feedTitle}ã€ã‚’è¿½åŠ ã—ã¾ã—ãŸ`);
  } catch(e) {
    console.error(e);
    showToast('è¿½åŠ ã§ãã¾ã›ã‚“ã§ã—ãŸ: ' + e.message);
  }
}

async function refreshFeed(feedId) {
  const feed = state.feeds.find(f => f.id === feedId);
  if (!feed) return;

  const btn = document.getElementById('refreshBtn');
  if (btn) btn.classList.add('loading');

  try {
    const xml = await proxyFetch(feed.url);
    const { feedTitle, favicon, items } = parseRSS(xml, feed.url);

    feed.title = feedTitle;
    feed.favicon = favicon;
    feed.lastFetch = new Date().toISOString();

    const existingUrls = new Set(state.articles.map(a => a.url));
    let newCount = 0;
    const newArticles = [];

    for (const item of items.slice(0, 30)) {
      if (!existingUrls.has(item.url)) {
        newArticles.push({
          id: genId(),
          feedId: feed.id,
          feedTitle: feed.title,
          title: item.title,
          url: item.url,
          date: item.date,
          thumb: item.thumb,
          read: false,
        });
        newCount++;
      }
    }

    if (newArticles.length > 0) {
      state.articles.unshift(...newArticles);
    }

    Storage.save();
    renderFeedList();
    renderArticleList();
    showToast(newCount > 0 ? `${newCount}ä»¶ã®æ–°ç€è¨˜äº‹ãŒã‚ã‚Šã¾ã™` : 'æœ€æ–°ã®çŠ¶æ…‹ã§ã™');
  } catch(e) {
    showToast('æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ');
  } finally {
    if (btn) btn.classList.remove('loading');
  }
}

function removeFeed(feedId) {
  state.feeds = state.feeds.filter(f => f.id !== feedId);
  state.articles = state.articles.filter(a => a.feedId !== feedId);
  if (state.selectedFeedId === feedId) {
    state.selectedFeedId = null;
    state.selectedArticleId = null;
    renderArticleList();
    showReaderEmpty();
  }
  Storage.save();
  renderFeedList();
  renderArticleList();
}

// ================================================
// è¨˜äº‹æœ¬æ–‡ã®æŠ½å‡º
// ================================================
const ARTICLE_SELECTORS = [
  'article', '#article-body', '#entry-body', '#main-article', '#post-body',
  '#article', '#content-main', '.article-body', '.entry-body', '.post-body',
  '.post-content', '.entry-content', '.article-content', '.main-article',
  '.article__body', '.matome-body', '.matome-content',
  "[class*='article']", "[class*='entry']", "[class*='post']", 'main',
];

const COMMENT_SELECTORS = [
  // æ±ç”¨
  '#comments', '#comment-list', '#comment_list', '#comment-area',
  '#comments-area', '#response', '#comment-section', '#disqus_thread',
  '.comments', '.comment-list', '.comment_list', '.comment-area',
  '.comments-area', '.comment-section', '.comment-wrap', '.comment__list',
  '.comment__container', '.articleComment',
  // ãƒãƒ ã‚¹ã‚¿ãƒ¼é€Ÿå ±ï¼ˆhamusoku.comï¼‰- #comments-list > ol > li.comment-set
  '#comments-list', '#comments-wrapper',
  '.comment-set', '#commentaries', '.commentaries',
  '#pcomment', '.pcomment', '#comment_area', '.comment_area',
  '#user_comments', '.user_comments', '#all-comment', '.all-comment',
  // jin115ãƒ»livedoorç³»
  '#blog-comment', '.blog-comment', '#blogComment',
  '#cmt', '.cmt', '#cmtlist', '.cmtlist',
  '#TrackBack', '#trackbacks',
  // 2chç³»ã¾ã¨ã‚å…¨èˆ¬
  '.res', '#res', '.reslist', '#reslist',
  '.thread', '#thread', '.komento', '#komento',
  "[class*='comment']", "[id*='comment']",
];

const NOISE_SELECTORS = [
  'header', 'footer', 'nav', 'aside', '.sidebar', '.side-bar',
  '.ad', '.ads', '.advertisement',
  "[class*='banner']", "[class*='recommend']", "[class*='related']",
  "[class*='ranking']", "[class*='popular']",
  "[id*='sidebar']", "[id*='ad']", "[id*='banner']",
  '.breadcrumb', '.breadcrumbs', '.share', '.sns', '.social',
  "[class*='share']", "[class*='sns']",
  'script', 'style', 'noscript',
];

const COMMENT_NOISE = [
  // æ±ç”¨
  '#comments', '#comments-area', '#comment-section', '#comment-list',
  '#comment_list', '#comment-area', '#comment_area', '#disqus_thread',
  '.comments', '.comment-list', '.comment_list', '.comment-area',
  '.comment-section', '.comment-wrap', '.comment__list', '.comment__container',
  '#comment-form', '.comment-form', '.comment-respond', '#respond', '.respond',
  // ãƒãƒ ã‚¹ã‚¿ãƒ¼é€Ÿå ±
  '#comments-list', '#comments-wrapper',
  // livedoorç³»ãƒ»jin115
  '#blog-comment', '.blog-comment', '#blogComment',
  '#cmt', '.cmt', '#cmtlist', '.cmtlist',
  // 2chç³»
  '[class*="comment-set"]',
];

function findBestNode(doc, selectors) {
  for (const sel of selectors) {
    try {
      const el = doc.querySelector(sel);
      if (el && (el.innerText || el.textContent || '').trim().length > 200) return el;
    } catch(e) {}
  }
  return null;
}

function cleanNode(node, removeComments = true) {
  const clone = node.cloneNode(true);
  const toRemove = removeComments ? [...NOISE_SELECTORS, ...COMMENT_NOISE] : NOISE_SELECTORS;
  for (const sel of toRemove) {
    try { clone.querySelectorAll(sel).forEach(el => el.remove()); } catch(e) {}
  }
  return clone;
}

// ================================================
// ã¾ã¨ã‚ãƒ–ãƒ­ã‚°ï¼šè¨˜äº‹ãƒãƒ¼ãƒ‰å¾Œã®å…„å¼Ÿãƒ¬ã‚¹ãƒ–ãƒ­ãƒƒã‚¯ã‚’çµåˆ
// ================================================
function mergeArticleSiblings(articleNode, doc) {
  const noisePattern = /sidebar|side-bar|banner|recommend|related|ranking|popular|breadcrumb|share|sns|social|advertisement|comment|comments|cmt/i;
  const noiseTags = new Set(['HEADER','FOOTER','NAV','ASIDE','SCRIPT','STYLE','NOSCRIPT']);

  // è¦ªã‚’æœ€å¤§4æ®µã¾ã§é¡ã£ã¦ã€Œã‚‚ã£ã¨ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ãŒå¤šã„ç¥–å…ˆã€ã‚’æ¢ã™
  // itainewsã®ã‚ˆã†ã«è¨˜äº‹ã¨ã‚¹ãƒ¬ãƒƒãƒ‰ãŒåˆ¥divã«ãªã£ã¦ã‚‹å ´åˆã«å¯¾å¿œ
  let best = articleNode;
  let node = articleNode.parentElement;

  for (let i = 0; i < 4 && node; i++) {
    const cls = (node.className || '').toString();
    const id  = (node.id || '');
    const tag = node.tagName;

    // ãƒã‚¤ã‚ºç³»ãƒ»bodyãƒ¬ãƒ™ãƒ«ã¯ã‚¹ã‚­ãƒƒãƒ—
    if (noiseTags.has(tag) || noisePattern.test(cls) || noisePattern.test(id)) break;
    if (tag === 'BODY' || tag === 'HTML') break;

    // ã“ã®è¦ªã®ä¸­ã«ãƒ†ã‚­ã‚¹ãƒˆãŒå¤šã„å­è¦ç´ ãŒè¤‡æ•°ã‚ã‚Œã°ã€ã“ã“ã‚’æ¡ç”¨
    const children = Array.from(node.children).filter(el => {
      if (noiseTags.has(el.tagName)) return false;
      if (noisePattern.test(el.className || '')) return false;
      return (el.textContent || '').trim().length > 100;
    });

    if (children.length >= 2) {
      best = node;
      break;
    }

    node = node.parentElement;
  }

  // æ¡ç”¨ã—ãŸè¦ç´ ã®ç›´å¾Œã®å…„å¼Ÿã‚‚æœ€å¤§5å€‹ã¾ã§å–ã‚Šè¾¼ã‚€ï¼ˆå…„å¼Ÿåˆ†å‰²ãƒ‘ã‚¿ãƒ¼ãƒ³å¯¾å¿œï¼‰
  const parent = best.parentElement;
  if (!parent || best === doc.body) return best;

  const siblings = [];
  let el = best.nextElementSibling;
  for (let i = 0; el && i < 5; el = el.nextElementSibling, i++) {
    const cls = (el.className || '').toString();
    if (noisePattern.test(cls) || noiseTags.has(el.tagName)) continue;
    if ((el.textContent || '').trim().length > 80) siblings.push(el);
  }

  if (siblings.length === 0) return best;

  const wrapper = doc.createElement('div');
  wrapper.appendChild(best.cloneNode(true));
  siblings.forEach(s => wrapper.appendChild(s.cloneNode(true)));
  return wrapper;
}

// ================================================
// Twitter / X åŸ‹ã‚è¾¼ã¿å¤‰æ›
// ================================================

// blockquote.twitter-tweet ã‚’è¦‹ã‚„ã™ã„ã‚«ãƒ¼ãƒ‰ã«å¤‰æ›
function convertTwitterEmbeds(node) {
  const tweets = node.querySelectorAll('blockquote.twitter-tweet, blockquote[class*="twitter"]');
  tweets.forEach(bq => {
    // ãƒ„ã‚¤ãƒ¼ãƒˆURLã‚’å–å¾—ï¼ˆæœ€å¾Œã®<a>ã‚¿ã‚°ãŒtwitter.com/xxx/status/xxxï¼‰
    const links = bq.querySelectorAll('a');
    let tweetUrl = null;
    let tweetText = '';
    links.forEach(a => {
      const href = (a.href || a.getAttribute('href') || '');
      if (/twitter\.com|x\.com/.test(href) && href.includes('/status/')) {
        tweetUrl = href;
      }
    });

    // ãƒ†ã‚­ã‚¹ãƒˆæœ¬æ–‡ï¼ˆ<a>ã‚¿ã‚°ä»¥å¤–ã®ãƒ†ã‚­ã‚¹ãƒˆï¼‰
    const textNodes = [];
    bq.childNodes.forEach(n => {
      if (n.nodeType === 3) textNodes.push(n.textContent.trim());
      else if (n.nodeType === 1 && n.tagName !== 'A') textNodes.push(n.textContent.trim());
    });
    tweetText = textNodes.filter(Boolean).join(' ').trim();

    // ã‚«ãƒ¼ãƒ‰ã«ç½®ãæ›ãˆ
    const card = document.createElement('div');
    card.className = 'tweet-card';
    card.innerHTML = `
      <div class="tweet-card-header">
        <span class="tweet-card-icon">ğ•</span>
        <span class="tweet-card-label">ãƒã‚¹ãƒˆ</span>
      </div>
      ${tweetText ? `<div class="tweet-card-text">${escHtml(tweetText)}</div>` : ''}
      ${tweetUrl ? `<a class="tweet-card-link" href="${escHtml(tweetUrl)}" target="_blank" rel="noopener">å…ƒã®ãƒã‚¹ãƒˆã‚’è¦‹ã‚‹ â†’</a>` : ''}
    `;
    bq.parentNode.replaceChild(card, bq);
  });
}

// ================================================
// æœ€åˆã®ã‚³ãƒ¡ãƒ³ãƒˆç›´å¾Œã®åºƒå‘Šã‚’æ¤œå‡ºãƒ»ä¿æŒ
// ================================================

// åºƒå‘Šè¦ç´ ã‹ã©ã†ã‹ã‚’åˆ¤å®šï¼ˆè¦ç´ ã‚µã‚¤ã‚ºåˆ¶é™ä»˜ãï¼‰
function isAdElement(el) {
  if (!el || el.nodeType !== 1) return false;
  const text = (el.textContent || '').trim();
  const cls = (el.className || '').toString().toLowerCase();
  const id  = (el.id || '').toLowerCase();
  const tag = el.tagName.toLowerCase();

  // ãƒ†ã‚­ã‚¹ãƒˆãŒé•·ã„è¦ç´ ã¯åºƒå‘Šã§ã¯ãªã„ï¼ˆè¨˜äº‹ã‚³ãƒ³ãƒ†ãƒ³ãƒ„èª¤æ¤œå‡ºé˜²æ­¢ï¼‰
  if (text.length > 200) return false;

  // Adsense ins ã‚¿ã‚°
  if (tag === 'ins' && cls.includes('adsbygoogle')) return true;

  // Adsense ã‚’å«ã‚€å°ã•ã„ã‚³ãƒ³ãƒ†ãƒŠ
  if (el.querySelector('ins.adsbygoogle')) return true;

  // ã‚¯ãƒ©ã‚¹/IDã§åˆ¤å®šï¼ˆå­è¦ç´ ãŒå°‘ãªã„å ´åˆã®ã¿ï¼‰
  if (/\bad[-_]|adsense|dfp|gpt-ad/i.test(cls) && el.querySelectorAll('*').length < 20) return true;
  if (/\bad[-_]|adsense/i.test(id) && el.querySelectorAll('*').length < 20) return true;

  // iframeãŒ1ã¤ã ã‘å…¥ã£ã¦ã„ã‚‹å°ã•ã„è¦ç´ 
  const iframes = el.querySelectorAll('iframe');
  if (iframes.length >= 1 && el.querySelectorAll('*').length < 10) return true;

  return false;
}

// ã‚¹ãƒãƒ³ã‚µãƒ¼ãƒªãƒ³ã‚¯ãƒ©ãƒ™ãƒ«ã®ç›´å¾Œã«ã‚ã‚‹å®Ÿéš›ã®åºƒå‘Šãƒãƒ¼ãƒ‰ã‚’å–å¾—
function findSponsorAdNode(labelEl) {
  // ãƒ©ãƒ™ãƒ«ã®æ¬¡ã®å…„å¼Ÿ
  let s = labelEl.nextElementSibling;
  for (let i = 0; s && i < 3; s = s.nextElementSibling, i++) {
    if (isAdElement(s)) return s.cloneNode(true);
  }
  // è¦ªã®æ¬¡ã®å…„å¼Ÿ
  const p = labelEl.parentElement;
  if (p) {
    let ps = p.nextElementSibling;
    for (let i = 0; ps && i < 3; ps = ps.nextElementSibling, i++) {
      if (isAdElement(ps)) return ps.cloneNode(true);
    }
    // è¦ªãŒå°ã•ã‘ã‚Œã°è¦ªã”ã¨è¿”ã™
    if ((p.textContent || '').trim().length < 200) return p.cloneNode(true);
  }
  return null;
}

// ã‚³ãƒ¡ãƒ³ãƒˆç›´å¾Œã®åºƒå‘Šã‚’å–å¾—
function findFirstCommentAd(doc) {
  const results = [];

  for (const sel of COMMENT_SELECTORS) {
    let container;
    try { container = doc.querySelector(sel); } catch(e) { continue; }
    if (!container) continue;

    // æœ€åˆã®ã‚³ãƒ¡ãƒ³ãƒˆç›´å¾Œã®å…„å¼Ÿ
    const firstComment = container.querySelector('li, [class*="comment-item"], [class*="commentItem"], dt, .res');
    if (firstComment) {
      let s = firstComment.nextElementSibling;
      for (let i = 0; s && i < 3; s = s.nextElementSibling, i++) {
        if (isAdElement(s)) { results.push(s.cloneNode(true)); break; }
      }
    }

    // ã‚³ãƒ³ãƒ†ãƒŠç›´å¾Œã®å…„å¼Ÿ
    let as = container.nextElementSibling;
    for (let i = 0; as && i < 3; as = as.nextElementSibling, i++) {
      if (isAdElement(as)) { results.push(as.cloneNode(true)); break; }
    }

    if (results.length > 0) break;
  }

  // ã€Œã‚¹ãƒãƒ³ã‚µãƒ¼ãƒ‰ãƒªãƒ³ã‚¯ã€ãƒ†ã‚­ã‚¹ãƒˆã‚’æŒã¤å°ã•ã„è¦ç´ ã‚’æ¢ã™
  if (results.length === 0) {
    const allEls = doc.querySelectorAll('div, p, span, h4, h5');
    for (const el of allEls) {
      const t = (el.textContent || '').trim();
      if (/^(ã‚¹ãƒãƒ³ã‚µãƒ¼[ãƒ‰ãƒ¼]?ãƒªãƒ³ã‚¯|ã‚¹ãƒãƒ³ã‚µãƒ¼ãƒ‰ãƒªãƒ³ã‚¯|Sponsored Links?)$/i.test(t)) {
        const adNode = findSponsorAdNode(el);
        if (adNode) results.push(adNode);
        break;
      }
    }
  }

  return results;
}
function extractArticle(html, url) {
  const parser = new DOMParser();
  const doc = parser.parseFromString(html, 'text/html');

  // ç›¸å¯¾URLã‚’çµ¶å¯¾URLã«å¤‰æ›
  try {
    doc.querySelectorAll('[src],[href]').forEach(el => {
      ['src','href'].forEach(attr => {
        const v = el.getAttribute(attr);
        if (v && !v.startsWith('http') && !v.startsWith('data:') && !v.startsWith('#')) {
          try { el.setAttribute(attr, new URL(v, url).href); } catch(e) {}
        }
      });
    });
  } catch(e) {}

  // OGPç”»åƒ
  const ogImg = doc.querySelector('meta[property="og:image"]')?.content || null;

  // è¨˜äº‹æœ¬æ–‡
  let articleNode = findBestNode(doc, ARTICLE_SELECTORS);
  if (!articleNode) {
    const blocks = Array.from(doc.querySelectorAll('div, section, main'))
      .filter(el => (el.textContent || '').trim().length > 300)
      .sort((a,b) => {
        const scoreA = (a.textContent||'').length / (a.querySelectorAll('*').length || 1);
        const scoreB = (b.textContent||'').length / (b.querySelectorAll('*').length || 1);
        return scoreB - scoreA;
      });
    articleNode = blocks[0] || doc.body;
  }

  // ã¾ã¨ã‚ãƒ–ãƒ­ã‚°å¯¾å¿œï¼šè¨˜äº‹ãƒãƒ¼ãƒ‰ã®å¾Œã‚ã«ã‚ã‚‹ãƒ¬ã‚¹ãƒ–ãƒ­ãƒƒã‚¯ã‚‚çµåˆã™ã‚‹
  // itainews ç­‰ã¯ã€Œãƒ‹ãƒ¥ãƒ¼ã‚¹è¦ç´„divã€ã¨ã€Œã‚¹ãƒ¬ãƒƒãƒ‰ãƒ¬ã‚¹divã€ãŒå…„å¼Ÿè¦ç´ ã«ãªã£ã¦ã„ã‚‹
  const mergedArticle = mergeArticleSiblings(articleNode, doc);

  const cleanedArticle = cleanNode(mergedArticle, true);
  // TwitteråŸ‹ã‚è¾¼ã¿ã‚’ã‚«ãƒ¼ãƒ‰åŒ–
  convertTwitterEmbeds(cleanedArticle);

  // ã‚³ãƒ¡ãƒ³ãƒˆæ¬„
  const commentNodes = [];
  for (const sel of COMMENT_SELECTORS) {
    try {
      doc.querySelectorAll(sel).forEach(el => {
        const alreadyCovered = commentNodes.some(f => f.contains(el) || el.contains(f));
        if (!alreadyCovered && (el.textContent||'').trim().length > 20) {
          commentNodes.push(el);
        }
      });
    } catch(e) {}
  }

  // ã‚³ãƒ¡ãƒ³ãƒˆã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
  const cleanedComments = commentNodes.map(node => {
    const clone = node.cloneNode(true);
    // åŸºæœ¬ãƒã‚¤ã‚ºé™¤å»
    ['script','style','noscript','iframe','.ad','form','input','button','textarea'].forEach(sel => {
      try { clone.querySelectorAll(sel).forEach(el => el.remove()); } catch(e) {}
    });
    // ã„ã„ã­ãƒ»ãƒãƒ¼ãƒˆãƒ»ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ç³»ã‚¯ãƒ©ã‚¹ã‚’é™¤å»
    [
      '[class*="like"]','[class*="heart"]','[class*="vote"]',
      '[class*="reaction"]','[class*="favorite"]','[class*="good"]',
      '[class*="clap"]','[class*="btn"]','[class*="button"]',
    ].forEach(sel => {
      try { clone.querySelectorAll(sel).forEach(el => el.remove()); } catch(e) {}
    });
    // å…¨imgè¦ç´ ã‚’ç²¾æŸ»ã—ã¦ä¸è¦ãªã‚‚ã®ã‚’é™¤å»
    clone.querySelectorAll('img').forEach(img => {
      const src = (img.getAttribute('src') || '').toLowerCase();
      const alt = (img.getAttribute('alt') || '').toLowerCase();
      // ãƒãƒ¼ãƒˆãƒ»ã„ã„ã­ãƒ»ã‚¢ã‚¤ã‚³ãƒ³ç³»ã®ç”»åƒã‚’é™¤å»
      if (/heart|like|good|vote|icon|emoji|stamp|sticker|avatar|face/i.test(src + alt)) {
        img.remove();
        return;
      }
      const p = img.parentElement;
      if (!p) return;
      const txt = (p.textContent || '').trim();
      // è¦ªã®ãƒ†ã‚­ã‚¹ãƒˆãŒã»ã¼ãªãç”»åƒã ã‘ã®æ§‹é€ ã¯é™¤å»
      if (txt.length < 5) {
        p.remove();
        return;
      }
    });
    // â™¡â¤ã ã‘ã®è¦ç´ ãƒ»æ•°å­—ã ã‘ã®è¦ç´ ã‚’é™¤å»ï¼ˆlivedoorã®ã„ã„ã­UIï¼‰
    // â€» querySelectorAllä¸­ã«è¦ç´ ã‚’å‰Šé™¤ã™ã‚‹ã¨ã‚¹ã‚­ãƒƒãƒ—ã•ã‚Œã‚‹ãŸã‚Arrayã«å¤‰æ›
    Array.from(clone.querySelectorAll('*')).forEach(el => {
      if (!el.isConnected) return;
      const txt = (el.textContent || '').trim();
      // ãƒãƒ¼ãƒˆçµµæ–‡å­—ãƒ»æ•°å­—ã ã‘ãƒ»ç©ºã®è¦ç´ ã‚’é™¤å»
      if (/^[â™¡â¤â™¥ğŸ’•ğŸ’—ğŸ’“ğŸ’ğŸ¤ğŸ©·ğŸ’–0-9\s]*$/.test(txt) && txt.length < 15 && !el.querySelector('li,p')) {
        try { el.remove(); } catch(e) {}
        return;
      }
      // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¢ã‚¤ã‚³ãƒ³ç”»åƒï¼ˆé¡”ã‚¢ã‚¤ã‚³ãƒ³ï¼‰+ ãƒ¦ãƒ¼ã‚¶ãƒ¼åã ã‘ã®ãƒ–ãƒ­ãƒƒã‚¯ã‚’é™¤å»
      const imgs = el.querySelectorAll('img');
      if (imgs.length >= 1 && txt.length < 30 && !el.querySelector('li')) {
        const hasHeartImg = Array.from(imgs).some(img => {
          const src = (img.getAttribute('src') || '').toLowerCase();
          return /heart|like|good|icon|face|avatar|stamp|emoji/i.test(src);
        });
        if (hasHeartImg) try { el.remove(); } catch(e) {}
      }
    });
    return clone;
  });

  // ã‚³ãƒ¡ãƒ³ãƒˆä»¶æ•°ï¼ˆãƒ†ã‚­ã‚¹ãƒˆãŒå®Ÿéš›ã«ã‚ã‚‹ã‚‚ã®ã®ã¿ï¼‰
  let commentCount = 0;
  for (const node of cleanedComments) {
    const items = node.querySelectorAll('li, [class*="comment-item"], [class*="comment-set"]');
    items.forEach(item => {
      if ((item.textContent || '').trim().length > 5) commentCount++;
    });
    if (commentCount === 0 && (node.textContent || '').trim().length > 10) commentCount = 1;
  }

  // æœ€åˆã®ã‚³ãƒ¡ãƒ³ãƒˆç›´å¾Œã®åºƒå‘Š
  const firstCommentAds = findFirstCommentAd(doc);

  return { ogImg, cleanedArticle, cleanedComments, commentCount: commentCount || null, firstCommentAds };
}

// ================================================
// è¨˜äº‹ã‚’é–‹ãï¼ˆãƒªãƒ¼ãƒ€ãƒ¼ãƒ¢ãƒ¼ãƒ‰ï¼‰
// ================================================
async function openArticle(articleId) {
  const article = state.articles.find(a => a.id === articleId);
  if (!article) return;

  state.selectedArticleId = articleId;
  article.read = true;
  Storage.saveRead();
  renderArticleList();

  // ãƒ¢ãƒã‚¤ãƒ«ã®å ´åˆã¯ãƒªãƒ¼ãƒ€ãƒ¼ã‚’ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤è¡¨ç¤º
  showReaderLoading(article);

  try {
    const html = await fetchArticleHTML(article.url);
    const { ogImg, cleanedArticle, cleanedComments, commentCount, firstCommentAds } = extractArticle(html, article.url);
    renderReader(article, cleanedArticle, cleanedComments, commentCount, ogImg, firstCommentAds);
  } catch(e) {
    renderReaderError(article, e.message);
  }
}

// ================================================
// UIãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
// ================================================

function renderFeedList() {
  const list = document.getElementById('feedList');
  list.innerHTML = '';

  if (state.feeds.length === 0) {
    list.innerHTML = `<li style="padding:16px;color:var(--text3);font-size:11px;text-align:center;line-height:1.7">
      ã¾ã ãƒ•ã‚£ãƒ¼ãƒ‰ãŒã‚ã‚Šã¾ã›ã‚“<br>ä¸‹ã®å…¥åŠ›æ¬„ã‹ã‚‰RSSã‚’è¿½åŠ ã—ã¦ãã ã•ã„
    </li>`;
    return;
  }

  state.feeds.forEach(feed => {
    const unread = state.articles.filter(a => a.feedId === feed.id && !a.read).length;
    const li = document.createElement('li');
    li.className = 'feed-item' + (state.selectedFeedId === feed.id ? ' active' : '');
    li.dataset.id = feed.id;

    li.innerHTML = `
      <div class="feed-icon">
        <img src="${feed.favicon}" onerror="this.parentNode.textContent='ğŸ“°'" alt="">
      </div>
      <div class="feed-info">
        <div class="feed-name">${escHtml(feed.title)}</div>
        <div class="feed-meta">
          <span>${state.articles.filter(a=>a.feedId===feed.id).length}ä»¶</span>
        </div>
      </div>
      ${unread > 0 ? `<div class="feed-unread">${unread}</div>` : ''}
      <button class="feed-remove" data-id="${feed.id}" title="å‰Šé™¤">âœ•</button>
    `;

    li.addEventListener('click', (e) => {
      if (e.target.classList.contains('feed-remove')) return;
      selectFeed(feed.id);
      // ãƒ¢ãƒã‚¤ãƒ«ã¯ãƒ‰ãƒ­ãƒ¯ãƒ¼ã‚’é–‰ã˜ã‚‹
      closeMobileDrawer();
    });

    li.querySelector('.feed-remove').addEventListener('click', (e) => {
      e.stopPropagation();
      if (confirm(`ã€Œ${feed.title}ã€ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)) removeFeed(feed.id);
    });

    list.appendChild(li);
  });
}

function selectFeed(feedId) {
  state.selectedFeedId = feedId;
  renderFeedList();
  renderArticleList();
}

function renderArticleList() {
  const container = document.getElementById('articleListContainer');
  const header = document.getElementById('articlePanelHeader');
  const emptyState = document.getElementById('emptyFeedState');

  if (!state.selectedFeedId) {
    header.style.display = 'none';
    container.innerHTML = '';
    container.appendChild(emptyState);
    emptyState.style.display = 'flex';
    return;
  }

  const feed = state.feeds.find(f => f.id === state.selectedFeedId);
  if (!feed) return;

  header.style.display = 'flex';
  document.getElementById('panelFeedTitle').textContent = feed.title;
  document.getElementById('mobilePanelTitle').textContent = feed.title;

  const articles = state.articles.filter(a => a.feedId === state.selectedFeedId);

  if (articles.length === 0) {
    container.innerHTML = `<div class="empty-state" style="flex:1;display:flex">
      <div class="icon">ğŸ“­</div>
      <div class="msg">è¨˜äº‹ãŒã‚ã‚Šã¾ã›ã‚“</div>
    </div>`;
    return;
  }

  const ul = document.createElement('ul');
  ul.className = 'article-list';
  ul.style.cssText = 'flex:1;overflow-y:auto;';

  articles.forEach(article => {
    const li = document.createElement('li');
    li.className = 'article-item' + (!article.read ? ' unread' : ' read')
      + (state.selectedArticleId === article.id ? ' active' : '');
    li.dataset.id = article.id;

    li.innerHTML = `
      ${article.thumb ? `<img class="article-thumb" src="${escHtml(article.thumb)}" loading="lazy" onerror="this.remove()" alt="">` : ''}
      <div class="article-title">${escHtml(article.title)}</div>
      <div class="article-meta">
        <span>${formatDate(article.date)}</span>
      </div>
    `;

    li.addEventListener('click', () => {
      openArticle(article.id);
      // ãƒ¢ãƒã‚¤ãƒ«ã®å ´åˆãƒªãƒ¼ãƒ€ãƒ¼ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤
      if (window.innerWidth <= 900) showMobileReader();
    });

    ul.appendChild(li);
  });

  container.innerHTML = '';
  container.appendChild(ul);
}

function showReaderEmpty() {
  document.getElementById('readerEmpty').style.display = 'flex';
  document.getElementById('readerContent').style.display = 'none';
}

function showReaderLoading(article) {
  document.getElementById('readerEmpty').style.display = 'none';
  const rc = document.getElementById('readerContent');
  rc.style.display = 'flex';
  rc.style.flexDirection = 'column';

  document.getElementById('readerUrl').textContent = new URL(article.url).hostname;
  document.getElementById('openOriginalBtn').href = article.url;
  document.getElementById('commentToggleBtn').style.display = 'none';
  state.commentsVisible = false;

  const body = document.getElementById('readerBody');
  body.innerHTML = `
    <div class="reader-loading">
      <div class="skeleton-bar" style="height:28px;width:70%;margin-bottom:8px"></div>
      <div class="skeleton-bar" style="height:28px;width:50%;margin-bottom:24px"></div>
      <div class="skeleton-bar" style="height:180px;width:100%;margin-bottom:24px"></div>
      ${[90,80,95,70,85].map(w=>`<div class="skeleton-bar" style="height:16px;width:${w}%;margin-bottom:10px"></div>`).join('')}
    </div>
  `;
}

function renderReader(article, cleanedArticle, cleanedComments, commentCount, ogImg, firstCommentAds = []) {
  const body = document.getElementById('readerBody');
  body.innerHTML = '';

  // ã‚¿ã‚¤ãƒˆãƒ«
  const titleEl = document.createElement('h1');
  titleEl.className = 'reader-article-title';
  titleEl.textContent = article.title;
  body.appendChild(titleEl);

  // ãƒ¡ã‚¿æƒ…å ±
  const metaEl = document.createElement('div');
  metaEl.className = 'reader-article-meta';
  metaEl.innerHTML = `
    <span>${formatDate(article.date)}</span>
    <span>${escHtml(article.feedTitle)}</span>
    <a href="${escHtml(article.url)}" target="_blank" rel="noopener">å…ƒè¨˜äº‹</a>
  `;
  body.appendChild(metaEl);

  // OGPç”»åƒ
  if (ogImg) {
    const heroEl = document.createElement('div');
    heroEl.className = 'reader-hero';
    heroEl.innerHTML = `<img src="${escHtml(ogImg)}" alt="${escHtml(article.title)}" onerror="this.parentNode.remove()">`;
    body.appendChild(heroEl);
  }

  // è¨˜äº‹æœ¬æ–‡
  const contentEl = document.createElement('div');
  contentEl.className = 'reader-content';
  contentEl.appendChild(cleanedArticle);
  contentEl.style.fontSize = state.readerFontSize + 'px';
  body.appendChild(contentEl);

  // â€» åºƒå‘Šè¡¨ç¤ºã¯ç¾åœ¨èª¿æ•´ä¸­ã®ãŸã‚ã‚ªãƒ•

  // ã‚³ãƒ¡ãƒ³ãƒˆã‚»ã‚¯ã‚·ãƒ§ãƒ³
  const commentBtn = document.getElementById('commentToggleBtn');
  if (cleanedComments.length > 0) {
    const commentsSection = document.createElement('div');
    commentsSection.className = 'comments-section hidden';
    commentsSection.id = 'commentsSection';

    const commentLabel = commentCount ? `ğŸ’¬ ã‚³ãƒ¡ãƒ³ãƒˆï¼ˆ${commentCount}ä»¶ï¼‰` : 'ğŸ’¬ ã‚³ãƒ¡ãƒ³ãƒˆ';
    commentsSection.innerHTML = `
      <div class="comments-title">
        <span>${commentLabel}</span>
        <button class="comments-hide-btn">â–² éš ã™</button>
      </div>
    `;

    cleanedComments.forEach(node => {
      const wrapper = document.createElement('div');
      wrapper.className = 'comments-inner';
      wrapper.appendChild(node);
      commentsSection.appendChild(wrapper);
    });

    body.appendChild(commentsSection);

    // ã‚³ãƒ¡ãƒ³ãƒˆãƒœã‚¿ãƒ³è¡¨ç¤º
    const label = commentCount ? `ğŸ’¬ ${commentCount}ä»¶` : 'ğŸ’¬ ã‚³ãƒ¡ãƒ³ãƒˆ';
    commentBtn.textContent = label;
    commentBtn.style.display = '';
    commentBtn.classList.remove('active');
    state.commentsVisible = false;

    commentsSection.querySelector('.comments-hide-btn').addEventListener('click', () => {
      commentsSection.classList.add('hidden');
      commentBtn.classList.remove('active');
      state.commentsVisible = false;
      body.scrollTo({ top: 0, behavior: 'smooth' });
    });
  } else {
    commentBtn.style.display = 'none';
  }
}

function renderReaderError(article, msg) {
  const body = document.getElementById('readerBody');
  body.innerHTML = `
    <h1 class="reader-article-title">${escHtml(article.title)}</h1>
    <div class="reader-article-meta">
      <a href="${escHtml(article.url)}" target="_blank" rel="noopener">å…ƒè¨˜äº‹ã‚’é–‹ã â†’</a>
    </div>
    <div style="margin-top:24px;padding:20px;background:var(--bg2);border:1px solid var(--border2);border-radius:8px;color:var(--text3);font-size:13px">
      <div style="margin-bottom:8px;color:var(--red)">è¨˜äº‹ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ</div>
      <div style="font-size:11px">${escHtml(msg)}</div>
      <div style="margin-top:12px;font-size:11px">
        â€» ã‚µã‚¤ãƒˆã®CORSè¨­å®šã«ã‚ˆã‚Šèª­ã¿è¾¼ã‚ãªã„å ´åˆãŒã‚ã‚Šã¾ã™ã€‚å…ƒè¨˜äº‹ãƒªãƒ³ã‚¯ã‹ã‚‰ç›´æ¥ã”è¦§ãã ã•ã„ã€‚
      </div>
    </div>
  `;
}

// ================================================
// ãƒ¢ãƒã‚¤ãƒ«å¯¾å¿œ
// ================================================
function showMobileReader() {
  if (window.innerWidth > 900) return;
  const rp = document.getElementById('reader-panel');
  rp.classList.add('mobile-reader-overlay');
  rp.style.display = 'flex';
  document.getElementById('article-panel').classList.add('hidden');
}

function hideMobileReader() {
  const rp = document.getElementById('reader-panel');
  rp.classList.remove('mobile-reader-overlay');
  rp.style.display = '';
  document.getElementById('article-panel').classList.remove('hidden');
}

function openMobileDrawer() {
  document.getElementById('feed-panel').classList.add('open');
  document.getElementById('drawerOverlay').classList.add('show');
}

function closeMobileDrawer() {
  document.getElementById('feed-panel').classList.remove('open');
  document.getElementById('drawerOverlay').classList.remove('show');
}

// ================================================
// ãƒˆãƒ¼ã‚¹ãƒˆ
// ================================================
let toastTimer = null;
function showToast(msg) {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.classList.add('show');
  clearTimeout(toastTimer);
  toastTimer = setTimeout(() => t.classList.remove('show'), 2800);
}

// ================================================
// ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£
// ================================================
function escHtml(str) {
  if (!str) return '';
  return String(str).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

// ================================================
// ã‚¤ãƒ™ãƒ³ãƒˆè¨­å®š
// ================================================
function initEvents() {
  // ãƒ†ãƒ¼ãƒåˆ‡æ›¿
  const themeToggleBtn = document.getElementById('themeToggleBtn');
  if (localStorage.getItem('rss_theme') === 'light') {
    document.body.classList.add('light');
    themeToggleBtn.textContent = 'â˜€';
  }
  themeToggleBtn.addEventListener('click', () => {
    const isLight = document.body.classList.toggle('light');
    themeToggleBtn.textContent = isLight ? 'â˜€' : 'â˜¾';
    localStorage.setItem('rss_theme', isLight ? 'light' : 'dark');
  });

  // ã‚«ãƒ©ãƒ ãƒˆã‚°ãƒ«
  document.getElementById('feedToggleBtn').addEventListener('click', () => {
    const collapsed = document.getElementById('feed-panel').classList.toggle('collapsed');
    document.getElementById('feedToggleBtn').textContent = collapsed ? 'â–¶' : 'â—€';
  });
  document.getElementById('articleToggleBtn').addEventListener('click', () => {
    const collapsed = document.getElementById('article-panel').classList.toggle('collapsed');
    document.getElementById('articleToggleBtn').textContent = collapsed ? 'â–¶' : 'â—€';
  });

  // ãŠã™ã™ã‚ãƒ•ã‚£ãƒ¼ãƒ‰ãƒ‘ãƒãƒ«
  function renderRecommendedPanel() {
    const list = document.getElementById('recList');
    list.innerHTML = '';
    RECOMMENDED_FEEDS.forEach(group => {
      const catEl = document.createElement('div');
      catEl.className = 'rec-category';
      catEl.textContent = group.category;
      list.appendChild(catEl);
      group.feeds.forEach(feed => {
        const added = state.feeds.some(f => f.url === feed.url);
        const item = document.createElement('div');
        item.className = 'rec-item';
        item.innerHTML = `
          <span class="rec-item-name">${escHtml(feed.name)}</span>
          <button class="rec-add-btn${added?' added':''}" data-url="${escHtml(feed.url)}" ${added?'disabled':''}>
            ${added?'è¿½åŠ æ¸ˆ':'è¿½åŠ '}
          </button>`;
        item.querySelector('.rec-add-btn').addEventListener('click', async (e) => {
          const btn = e.currentTarget;
          if (btn.disabled) return;
          btn.disabled = true; btn.textContent = 'èª­è¾¼ä¸­...';
          await addFeed(btn.dataset.url);
          btn.textContent = 'è¿½åŠ æ¸ˆ'; btn.classList.add('added');
        });
        list.appendChild(item);
      });
    });
  }
  document.getElementById('openRecommendedBtn').addEventListener('click', () => {
    renderRecommendedPanel();
    document.getElementById('recommendedPanel').classList.add('open');
  });
  document.getElementById('closeRecommendedBtn').addEventListener('click', () => {
    document.getElementById('recommendedPanel').classList.remove('open');
  });

  // ãƒ•ã‚£ãƒ¼ãƒ‰è¿½åŠ 
  document.getElementById('addFeedBtn').addEventListener('click', async () => {
    const input = document.getElementById('feedUrlInput');
    const btn = document.getElementById('addFeedBtn');
    btn.disabled = true;
    await addFeed(input.value);
    input.value = '';
    btn.disabled = false;
  });

  document.getElementById('feedUrlInput').addEventListener('keydown', async (e) => {
    if (e.key === 'Enter') {
      const btn = document.getElementById('addFeedBtn');
      btn.click();
    }
  });

  // æ›´æ–°ãƒœã‚¿ãƒ³
  document.getElementById('refreshBtn').addEventListener('click', () => {
    if (state.selectedFeedId) refreshFeed(state.selectedFeedId);
  });

  // ãƒ•ã‚©ãƒ³ãƒˆã‚µã‚¤ã‚º
  document.getElementById('fontSmallBtn').addEventListener('click', () => {
    state.readerFontSize = Math.max(12, state.readerFontSize - 1);
    const c = document.querySelector('.reader-content');
    if (c) c.style.fontSize = state.readerFontSize + 'px';
  });

  document.getElementById('fontLargeBtn').addEventListener('click', () => {
    state.readerFontSize = Math.min(22, state.readerFontSize + 1);
    const c = document.querySelector('.reader-content');
    if (c) c.style.fontSize = state.readerFontSize + 'px';
  });

  // ã‚³ãƒ¡ãƒ³ãƒˆãƒˆã‚°ãƒ«
  document.getElementById('commentToggleBtn').addEventListener('click', () => {
    const section = document.getElementById('commentsSection');
    const btn = document.getElementById('commentToggleBtn');
    if (!section) return;
    state.commentsVisible = !state.commentsVisible;
    section.classList.toggle('hidden', !state.commentsVisible);
    btn.classList.toggle('active', state.commentsVisible);
    if (state.commentsVisible) {
      setTimeout(() => section.scrollIntoView({ behavior: 'smooth', block: 'start' }), 50);
    }
  });

  // ãƒ¢ãƒã‚¤ãƒ«
  document.getElementById('mobileMenuBtn').addEventListener('click', openMobileDrawer);
  document.getElementById('drawerOverlay').addEventListener('click', closeMobileDrawer);

  // ãƒ¢ãƒã‚¤ãƒ«ãƒªãƒ¼ãƒ€ãƒ¼é–‰ã˜ã‚‹ï¼ˆãƒ˜ãƒƒãƒ€ãƒ¼ã®ã€Œâ†ã€ï¼‰
  document.addEventListener('keydown', e => {
    if (e.key === 'Escape') hideMobileReader();
  });

  // ãƒ¢ãƒã‚¤ãƒ«ãƒªãƒ¼ãƒ€ãƒ¼ã«ãƒãƒƒã‚¯ãƒœã‚¿ãƒ³è¿½åŠ 
  if (window.innerWidth <= 900) {
    const rh = document.getElementById('readerHeader');
    const backBtn = document.createElement('button');
    backBtn.className = 'ctrl-btn';
    backBtn.textContent = 'â† æˆ»ã‚‹';
    backBtn.style.marginRight = 'auto';
    backBtn.addEventListener('click', hideMobileReader);
    rh.prepend(backBtn);
  }
}

// ================================================
// ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ•ã‚£ãƒ¼ãƒ‰
// ================================================
const RECOMMENDED_FEEDS = [
  { category: 'ãƒ©ã‚¤ãƒ–ãƒ‰ã‚¢ãƒ‹ãƒ¥ãƒ¼ã‚¹', feeds: [
    { url: 'https://news.livedoor.com/topics/rss/top.xml',  name: 'ä¸»è¦ãƒˆãƒ”ãƒƒã‚¯ã‚¹' },
    { url: 'https://news.livedoor.com/topics/rss/dom.xml',  name: 'å›½å†…ãƒ‹ãƒ¥ãƒ¼ã‚¹' },
    { url: 'https://news.livedoor.com/topics/rss/int.xml',  name: 'æµ·å¤–ãƒ‹ãƒ¥ãƒ¼ã‚¹' },
    { url: 'https://news.livedoor.com/topics/rss/inet.xml', name: 'ITãƒ»ãƒãƒƒãƒˆ' },
    { url: 'https://news.livedoor.com/topics/rss/eco.xml',  name: 'çµŒæ¸ˆãƒ‹ãƒ¥ãƒ¼ã‚¹' },
    { url: 'https://news.livedoor.com/topics/rss/ent.xml',  name: 'ã‚¨ãƒ³ã‚¿ãƒ¡' },
    { url: 'https://news.livedoor.com/topics/rss/spo.xml',  name: 'ã‚¹ãƒãƒ¼ãƒ„' },
  ]},
  { category: 'ç·åˆãƒ»ãƒ‹ãƒ¥ãƒ¼ã‚¹ç³»ã¾ã¨ã‚', feeds: [
    { url: 'https://itainews.com/',                         name: 'ç—›ã„ãƒ‹ãƒ¥ãƒ¼ã‚¹(ãƒâˆ€`)' },
    { url: 'https://jin115.com/index.rdf',                  name: 'ã‚ªãƒ¬çš„ã‚²ãƒ¼ãƒ é€Ÿå ±@åˆƒ' },
    { url: 'http://blog.livedoor.jp/itsoku/',               name: 'ITé€Ÿå ±' },
    { url: 'http://matometanews.com/index.rdf',             name: 'ã¾ã¨ã‚ãŸãƒ‹ãƒ¥ãƒ¼ã‚¹' },
  ]},
  { category: 'æ”¿æ²»ãƒ»çµŒæ¸ˆ', feeds: [
    { url: 'https://kabumatome.doorblog.jp/',               name: 'å¸‚æ³ã‹ã¶å…¨åŠ›2éšå»º' },
    { url: 'https://toushichannel.net/index.rdf',           name: 'æŠ•è³‡ã¡ã‚ƒã‚“ã­ã‚‹' },
    { url: 'https://taikankyohou.com/',                     name: 'å¤§è‰¦å·¨ç ²ä¸»ç¾©!' },
    { url: 'https://mona-news.com/index.rdf',               name: 'ãƒ¢ãƒŠãƒ‹ãƒ¥ãƒ¼ã‚¹' },
  ]},
  { category: 'ãªã‚“Gãƒ»VIPç³»', feeds: [
    { url: 'https://hamusoku.com/index.rdf',                name: 'ãƒãƒ ã‚¹ã‚¿ãƒ¼é€Ÿå ±' },
    { url: 'https://nwknews.jp/',                           name: 'å“²å­¦ãƒ‹ãƒ¥ãƒ¼ã‚¹' },
    { url: 'http://world-fusigi.net/index.rdf',             name: 'ä¸æ€è­°.net' },
    { url: 'http://blog.livedoor.jp/goldennews/',           name: 'ã‚´ãƒ¼ãƒ«ãƒ‡ãƒ³ã‚¿ã‚¤ãƒ ã‚º' },
  ]},
  { category: 'ç‰¹åŒ–ç³»', feeds: [
    { url: 'https://nanjpride.blog.jp/',                    name: 'ãªã‚“J PRIDE' },
    { url: 'https://blog.domesoccer.jp/feed',               name: 'ãƒ‰ãƒ¡ã‚µã‚«ãƒ–ãƒ­ã‚°' },
    { url: 'http://nofootynolife.net/?xml',                  name: 'NO FOOTY NO LIFE' },
    { url: 'http://blog.livedoor.jp/kaikaihanno/',          name: 'ã‚«ã‚¤ã‚«ã‚¤åå¿œé€šä¿¡' },
    { url: 'http://blog.livedoor.jp/diet2channel/',         name: 'ãƒ€ã‚¤ã‚¨ãƒƒãƒˆé€Ÿå ±' },
    { url: 'https://kazokuchannel.doorblog.jp/index.rdf',   name: 'ã‹ããã¡ã‚ƒã‚“ã­ã‚‹' },
    { url: 'http://blog.livedoor.jp/kekkongo/',             name: 'çµå©šãƒ»æ‹æ„›ãƒ‹ãƒ¥ãƒ¼ã‚¹ã·ã‚‰ã™' },
    { url: 'https://oryouri.2chblog.jp/',                   name: 'ãŠæ–™ç†é€Ÿå ±' },
  ]},
];

// ================================================
// åˆæœŸåŒ–
// ================================================
async function init() {
  Storage.load();
  initEvents();
  renderFeedList();
  renderArticleList();

  // ãƒ•ã‚£ãƒ¼ãƒ‰ãŒç©ºãªã‚‰æ¡ˆå†…ã ã‘è¡¨ç¤º
  if (state.feeds.length === 0) {
    showToast('RSSãƒ•ã‚£ãƒ¼ãƒ‰ã®URLã‚’å…¥åŠ›ã—ã¦è¿½åŠ ã—ã¦ãã ã•ã„');
  } else {
    // æœ€åˆã®ãƒ•ã‚£ãƒ¼ãƒ‰ã‚’é¸æŠ
    selectFeed(state.feeds[0].id);
  }
}

init();
</script>
</body>
</html>
